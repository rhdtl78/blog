<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.8">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Jeonghun Kong&#39;s Devlog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Jeonghun Kong&#39;s Devlog Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Jeonghun Kong&#39;s Devlog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Jeonghun Kong&#39;s Devlog Atom Feed"><title data-react-helmet="true">Spring boot TDD | Jeonghun Kong&#x27;s Devlog</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://rhdtl78.github.io/study/spring/auto-monitor"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Spring boot TDD | Jeonghun Kong&#x27;s Devlog"><meta data-react-helmet="true" name="description" content="Spring Boot + JPA + JUnit + Mockito"><meta data-react-helmet="true" property="og:description" content="Spring Boot + JPA + JUnit + Mockito"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2020-07-16T00:00:00.000Z"><meta data-react-helmet="true" property="article:tag" content="Spring,Springboot,TDD,Mockito"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://rhdtl78.github.io/study/spring/auto-monitor"><link data-react-helmet="true" rel="alternate" href="https://rhdtl78.github.io/study/spring/auto-monitor" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://rhdtl78.github.io/study/spring/auto-monitor" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d0ecee25.css">
<link rel="preload" href="/assets/js/runtime~main.a5b0cd21.js" as="script">
<link rel="preload" href="/assets/js/main.53cff753.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://github.com/rhdtl78.png" alt="Devlog Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="https://github.com/rhdtl78.png" alt="Devlog Logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Devlog</b></a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/cv">CV</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/rhdtl78" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">🌜</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">🌞</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/study/object/chapter/09">[오브젝트] Chapter09. 유연한 설계</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/study/object/chapter/07">[오브젝트] Chapter07. 객체 분해</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/study/object/chapter/06">[오브젝트] Chapter06. 메시지와 인터페이스</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/study/object/chapter/05">[오브젝트] Chapter05. 책임 할당하기. - GRASP Pattern</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/study/object/chapter/03">[오브젝트] Chapter03. 역할, 책임, 협력.</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Spring boot TDD</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2020-07-16T00:00:00.000Z" itemprop="datePublished">July 16, 2020</time> · <!-- -->13 min read</div></header><div class="markdown" itemprop="articleBody"><ol><li><p>개요</p><ul><li>Spring Boot 스터디를 위한 프로젝트로 AutoMonitor를 개발.</li><li>Mockito를 Springboot 환경에서 TDD방법론으로 접근해 사용해보는 것이 학습 목표.</li><li>궁극적으로, CI/CD Tool (e.g. jenkins) 를 활용하여 자동화 하는 것이 개발 목표.</li></ul><p>AutoMonitor란?</p><ul><li>Api Testing Application</li><li>주어진 API가 주어진 payload로 정상 작동하는가를 확인</li><li>API Health checking</li></ul><p>Stack</p><ul><li>Kotlin</li><li>Springboot</li><li>JPA</li><li>Junit</li><li>Mockito</li><li>Hibernate</li><li>JPA</li><li>Vue</li></ul><p>학습 전략</p><ul><li>TDD (Test Driven Development)</li><li>레이어 별로 Mock-up</li><li>항상 Test Case를 먼저 작성할 것</li></ul><p>환경 설정에 대한 설명은 생략.</p></li><li><p>Test Driven Development</p><p>TDD란? </p><blockquote><p>테스트 주도 개발(Test-driven development TDD)은 매우 짧은 개발 사이클을 반복하는 소프트웨어 개발 프로세스 중 하나이다.
개발자는 먼저 요구사항을 검증하는 자동화된 테스트 케이스를 작성한다. 그런 후에, 그 테스트 케이스를 통과하기 위한 최소한의 코드를 생성한다.
마지막으로 작성한 코드를 표준에 맞도록 리팩토링한다.
이 기법을 개발했거나 &#x27;재발견&#x27; 한 것으로 인정되는 Kent Beck은 2003년에 TDD가 단순한 설계를 장려하고 자신감을 불어넣어준다고 말하였다.
-- Wiki에서 발췌 <a href="https://ko.wikipedia.org/wiki/%ED%85%8C%EC%8A%A4%ED%8A%B8_%EC%A3%BC%EB%8F%84_%EA%B0%9C%EB%B0%9C" target="_blank" rel="noopener noreferrer">링크</a></p></blockquote><p>주목할 것은 &#x27;먼저 요구사항을 검증하는 자동화된 테스트 케이스를 작성한다.&#x27; 이다.
테스트 케이스 자체가 기능 명세가 되고, 프로그램의 청사진이 된다.</p><ol><li><p>JPA Repository Mocking</p><p>테스트의 목적은 작성한 Entity를 사용한 JpaRepository를 Mock-up 해보기 위함이다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/* Test Case */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RunWith(MockitoJUnitRunner::class) // Mockito runner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ApiSpecJpaRepositoryTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Mock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var apiSpecJpaRepository: ApiSpecJpaRepository; // jpaRepository를 Mockito로 Mock-up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @InjectMocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var apiSpecRepository: ApiSpecRepository; // jpaRepository를 이용한 Respository. apiSpecJpaRepository를 의존 객체로 갖는다.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @BeforeAll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun setUp() { // Mockito의 어노테이션을 실행.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MockitoAnnotations.initMocks(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/* JPA Repository */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Repository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface ApiSpecJpaRepository: JpaRepository&lt;ApiSpec, Long&gt;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/* Repository */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Repository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ApiSpecRepository(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val jpaApiSpecRepository: ApiSpecJpaRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>MockitoRunner가 의존성을 주입해주며 Mock-up을 만들어 준다. 위 테스트 클래스에서는 apiSpecJpaRepository가 Mock-up 객체가 되며 이를 apiSpecRepository가 사용한다.</p><p>등록된 API를 조회하는 기능을 구현하고자 한다. 이 때, Respository에 해당 기능을 바로 구현하지 않고, 인터페이스만 놓아둔다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/* Repository */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Repository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ApiSpecRepository(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val jpaApiSpecRepository: ApiSpecJpaRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      * 등록된 api 목록 가져오기</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun getApis(page: Int): List&lt;ApiSpec&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return listOf();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>그리고 바로 테스트 케이스를 작성한다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/* Test Case */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ApiSpecJpaRepositoryTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private fun mockResultList(size: Long): List&lt;ApiSpec&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return LongStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .range(0, size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .mapToObj {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    val mocked = mock&lt;ApiSpec&gt;(); // Mock-up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // Data mocking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    whenever(mocked.id).thenReturn(it + 1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    whenever(mocked.alias).thenReturn(&quot;Test Api - ${it + 1}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    whenever(mocked.url).thenReturn(&quot;/api/v1/test/${it + 1}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    whenever(mocked.payload).thenReturn(&quot;{ \&quot;data\&quot;: { \&quot;number\&quot;: ${it + 1} } }&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    mocked;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .toList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    * 첫 페이지에 해당하는 API 목록을 불러온다.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun getApis_페이지_번호로_조회하기() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val page: Int = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val recordSize: Int = 12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val paging = PageRequest.of(page, recordSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // mocking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val mockedResults = mockResultList(12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val mockedPage = PageImpl&lt;ApiSpec&gt;(mockedResults)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        whenever(apiSpecJpaRepository.findAll(paging))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .thenReturn(mockedPage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        assertEquals(12, apiSpecRepository.getApis(page).size);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>여기서 주목할 것은 mockResultList와 테스트 케이스의 mocking방법이다.</p><p>mockResultList는 integer를 인자로 받아 그 값을 크기로 갖는 ApiSpec의 Mock-up 객체의 List를 반환한다.</p><p>데이터들은 실제 값을 직접 바인드 하지 않고, Mockito의 whenever로 Mock-up 데이터를 생성한다.</p><p>테스트 케이스에서는 apiSpecJpaRepository.findAll 의 결과를 mock-up 한다.</p><p>apiSpecJpaRepository의 findAll 함수에 PageRequest 인자를 넘겨주어 실행하면 12개의 원소를 가진 List객체가 반환된다는 의미이다.</p><p>물론 데이터는 모두 Mock-up된 상태이다.</p><p>테스트를 수행하면 당연히 통과하지 못한다. apiSpecRepository에서 테스트하려는 getApis가 의미없는 반환을 하고있기 때문이다.</p><p>이제 이 테스트 케이스를 통과하기 위해 ApiSpecRepository의 getApis함수를 마저 구현한다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@Repository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ApiSpecRepository(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val jpaApiSpecRepository: ApiSpecJpaRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    val recordSize: Int = 12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 등록된 api 목록 가져오기</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun getApis(page: Int): List&lt;ApiSpec&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val paging = PageRequest.of(page, recordSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val result: Page&lt;ApiSpec&gt;? = jpaApiSpecRepository.findAll(paging);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (result != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result.content;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return listOf();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>PageRequest를 이용해 쿼리 결과를 제한하며, 반환할 내용은 모두 List로 변환한다.</p><p>이제 테스트를 다시 수행하면 통과할 것이다. 테스트가 통과할 수 있는 이유는 바로 apiSpecJpaRepository가 Mock-up 되었기 때문이다.</p><p>Mockito Test Runner가 @Mock으로 지정된 필드를 Mock-up해두고, Mock-up된 apiSpecJpaRepository를 @InjectMocks로 지정된 apiSpecRepository에 의존성 주입을 실행한다. 따라서 apiSpecRepository 내부에는 Mock-up된 jpaRepository가 위치하게 되며 내부에서 apiSpecJpaRepository를 통해 메서드를 호출할 수 있게 되었다.</p><p>또한, 내부의 함수를 whenever로 Mock-up했기 때문에 실제 Database에 쿼리를 질의하지 않고 기능이 동작 할 수 있었다.</p><p>이런 방법으로 테스트 케이스를 먼저 작성하고, 테스트를 수행하고, 실패한 테스트에 대해 리팩터링을 진행하는 것이 TDD의 기본이다.</p></li><li><p>Repository Test</p><p>Repository Test에서는 데이터의 저장, 조회가 내가 의도한 대로 이뤄지는지를 확인해야 하기 때문에 별도의 Mock-up을 만들지 않는다.
간단하게 Save-Load Test를 수행한다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@RunWith(SpringRunner::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootTest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ApiSpecRepositoryTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var apiSpecRepository: ApiSpecRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @BeforeAll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun setUp() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (i: Int in 1..60) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val data = ApiForm(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    url = &quot;http://localhost/api/v1/test/$i&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    alias = &quot;TestApi - $i&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    payload = &quot;{ data: [] }&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            apiSpecRepository.saveApi(data);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @AfterAll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun cleanUp() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        apiSpecRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .jpaApiSpecRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .deleteAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>우선 setup과 cleanUp을 구성한다. 테스트 시작 전에 데이터를 미리 구성해 두고, 이후엔 테스트에 사용한 모든 데이터를 모두 제거한다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@RunWith(SpringRunner::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootTest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ApiSpecRepositoryTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun `saveApi - 새로운 API 등록`() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // mocking</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val inputData = ApiForm(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                url = &quot;http://test/api/v1/mocked&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                alias = &quot;test&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                payload = &quot;{ \&quot;data\&quot; : \&quot;test\&quot; }&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val inserted = apiSpecRepository.saveApi(inputData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val result = apiSpecRepository.jpaApiSpecRepository.findById(inserted.id!!).get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(inputData.url, result.url);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(inputData.alias, result.alias);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(inputData.payload, result.payload);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Save 테스트에서는 데이터를 넣어보고, 이를 다시 꺼내어 확인하는 방식으로 테스트를 진행했다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@RunWith(SpringRunner::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootTest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ApiSpecRepositoryTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun `getApi - 단건 조회`() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val id : Long = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val result = apiSpecRepository.getApi(id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertNotNull(result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Assertions.assertEquals(result!!.id!!, id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Load Test에선 기존 준비한 데이터를 꺼내보는 방향으로 진행했다.</p></li><li><p>Controller Test
Controller Test는 앞서서 만든 Repository를 Mock-Up해서 진행한다. Controller Test의 목적은 매핑된 함수들이 제대로 동작 하는지를 보기 위함이지 데이터를 꺼내오는 것이 제대로 동작하는 것을 보는 것이 아니기 때문이다. 관심사를 생각해서 테스트 케이스와 Mock-Up 범위를 결정한다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@RunWith(MockitoJUnitRunner::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootTest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AutoConfigureMockMvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DashboardControllerTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Mock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var apiSpecRepository: ApiSpecRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @InjectMocks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lateinit var dashboardController: DashboardController;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Before</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun setUp() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MockitoAnnotations.initMocks(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private fun mockResultList(size: Long): List&lt;ApiSpec&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return LongStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .range(0, size)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .mapToObj {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ApiSpec(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            id = it + 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            alias = &quot;Test Api - ${it + 1}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            url = &quot;/api/v1/test/${it + 1}&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            payload = &quot;{ \&quot;data\&quot;: { \&quot;number\&quot;: ${it + 1} } }&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .toList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>우선 테스트 준비를 위와 같이 해둔다. 실제 Request를 주고 받는 테스트를 할 것이기 때문에 MockMVC를 사용한다. 앞서서 언급한 대로 apiSpecRepository는 Mock-UP해 두고 테스트 케이스 마다 예상 값을 정한다. 테스트 데이터는 엔티티를 사용하였다. JpaRepository테스트와 다른 점은 데이터 자체를 다시 Mockito로 Mock-Up하지 않은 것이다. Object De/Serialize에서 Mock-up객체의 다른 메서드, 프로퍼티들이 함께 결과에 포함 될 수 있기 때문에 데이터를 직접 구성하게 했다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@RunWith(MockitoJUnitRunner::class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootTest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AutoConfigureMockMvc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@TestInstance(TestInstance.Lifecycle.PER_CLASS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DashboardControllerTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun `getRegisteredApis - API Calling 테스트 - 데이터 조회`() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val mockedList = mockResultList(12)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        whenever(apiSpecRepository.getApis(1))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .thenReturn(mockedList);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val request = get(&quot;/api/v1/apis/1&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .accept(MediaType.APPLICATION_JSON);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MockMvcBuilders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .standaloneSetup(dashboardController)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .perform(request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .andExpect(status().isOk)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .andDo(ResultHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    println(it.response.contentAsString);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .andExpect(jsonPath(&quot;$&quot;).isArray)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .andExpect(jsonPath(&quot;$.*&quot;, Matchers.hasSize&lt;ApiSpec&gt;(12)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>조회 테스트이다. Mock-Up 데이터를 12개 (1 page 분량)을 준비해두고 페이지 번호를 주어 요청하는 테스트 시나리오이다.
이제 테스트를 수행하면 실패할 것이다. 컨트롤러에 가서 해당 기능을 구현한다.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly kotlin"><pre tabindex="0" class="prism-code language-kotlin codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DashboardController(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        val apiSpecRepository: ApiSpecRepository</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/api/v1/apis/{page}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fun getRegisteredApis(@PathVariable(&quot;page&quot;) page: Int): List&lt;ApiSpec&gt; = apiSpecRepository.getApis(page)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Get요청 테스트를 작성했으니 GetMapping을 구성한다. Restful 디자인을 사용했다.
다시 테스트를 수행하면 통과한다.</p></li><li><p>반복...</p><p>이제 기능을 개발할 때 마다 위 흐름을 반복하면된다. </p><ol><li>Test Case 작성<ul><li>JpaRepository<ul><li>어떤 메서드를 사용해 데이터를 가져올 지 정한다.</li><li>Repository에 해당 메서드를 사용하는 기능의 껍데기를 만든다.</li><li>Repository에 JpaRepository의 Mock-Up을 의존성으로 주입한다.</li></ul></li><li>Repository<ul><li>mock-up없이, 실제 데이터의 CRUD가 이뤄지는지를 확인하는 테스트 케이스를 작성한다.</li></ul></li><li>Controller<ul><li>Repository로 꺼내온 데이터를 어떻게 핸들링 할 지에 대해 테스트 케이스를 작성한다.</li><li>실제 Request와 유사하게 테스트해야 하므로 MockMVC를 사용하는 것을 권장한다.</li><li>Repository의 Mock-Up을 Controller의 의존성으로 주입한다.</li></ul></li></ul></li><li>Test 수행</li><li>Refactoring</li></ol></li></ol></li><li><p>앞으로...</p><ol><li>Frontend와 Api연동.<ul><li>현재까지 작성된 Api들을 Frontend와 연동해 기능의 동작을 확인한다.</li></ul></li><li>CI/CD툴과 연동.<ul><li>Jenkins로 배치 프로세스를 구성해 테스트를 주기적으로, 자동화 한다.</li></ul></li></ol></li></ol></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/spring">Spring</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/springboot">Springboot</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/tdd">TDD</a></li><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/tags/mockito">Mockito</a></li></ul></div><div class="col margin-top--sm"><a href="https://rhdtl78.github.io/study/2020-07-16-spring-auto-monitor-index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/study/kafka/chapter/03"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« <!-- -->[Kafka] Chapter03. 카프카 디자인</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/study/spring/external_configuration"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">외부 설정<!-- --> »</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Jeonghun Kong. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a5b0cd21.js"></script>
<script src="/assets/js/main.53cff753.js"></script>
</body>
</html>